name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: 'frontend/yarn.lock'
      
      - name: Install dependencies
        working-directory: ./frontend
        run: yarn install --frozen-lockfile
      
      - name: Build project
        working-directory: ./frontend
        run: yarn build
      
      - name: Deploy to GitHub Pages
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Copy built files to root - verbose
          echo "Copying frontend/build contents to root..."
          cp -rv frontend/build/* .
          
          # Ensure .nojekyll exists
          touch .nojekyll
          echo "Created .nojekyll"
          
          # List files to verify they exist
          echo "Files at root after copy:"
          ls -la index.html static/ manifest.json asset-manifest.json 2>&1 || echo "Some files missing"
          
          # Git add all new/modified files
          echo "Adding files to git..."
          git add .
          
          # Check status
          echo "Git status:"
          git status
          
          # Commit (will not be empty if files changed)
          echo "Committing..."
          git commit -m "Deploy: automated GitHub Pages deployment" || echo "No changes to commit"
          
          # Push
          echo "Pushing..."
          git push origin master
